<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta content="stuff, to, help, search, engines, not" name="keywords">
  <meta content="What this page is about." name="description">
  <meta content="Display Webcam Stream" name="title">
  <title>Display Webcam Stream</title>

  <style>
    #container {
      margin: 0px auto;
      border: 10px #333 solid;
    }

    #videoElement {
      width: 160px;
      height: 90px;
      background-color: #666;
    }

    canvas {
      width: 160px;
      height: 90px;
      background-color: #666;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.12.5"> </script>
  <script src="smoothie.js"> </script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>


<body>
  <div id="container">

    <video autoplay="true" id="videoElement" controls>
      <source src="output_320_full.mp4" type="video/mp4">
    </video>

    <canvas height=90px width=160px id="canvas"></canvas>
    <canvas height=90px width=160px id="canvas2"></canvas>
    <canvas height=90px width=160px id="canvas3"></canvas>
    <canvas height=90px width=160px id="canvas4"></canvas>
    <canvas height=90px width=160px id="canvas5"></canvas>
  </div>

  <h2 id="makingShot">Making shot</h2>

  <canvas id="chart" width="400" height="100"></canvas>

  <h3 id="fps"></h3>

  <button onclick="capture_train_display()">Click me</button>

  <h2 id="angle">
    </h3>

    <div id="pointData">
      <!-- Plotly chart will be drawn inside this DIV -->
    </div>

    <script src="app.1.js"></script>
    <script>
      var video
      var videoFeed
      var deltaFeed
      var trailFeed
      var videoFeeding = true

      window.addEventListener('load', function () {
        console.log('All assets are loaded')

        // feed video into first canvas
        video = document.querySelector("#videoElement");
        videoFeed = new CanvasScreen('canvas', 160, 90)

        // feed grayscale of first canvas into delta canvas
        deltaFeed = new DeltaCanvas('canvas2', 160, 90)
        deltaFeed.watchUpdate = function () {
          deltaFeed.addFrame(videoFeed.getGrayScaleImage().data)
          deltaFeed.displayCurrentDelta()
        }
        videoFeed.addWatcher(deltaFeed)

        // feed delta canvas into trail canvas
        trailFeed = new TrailCanvas('canvas3', 160, 90)
        trailFeed.watchUpdate = function () {
          trailFeed.addFrame(deltaFeed.getImage().data)
          trailFeed.displayCurrentTrailFrame()
        }
        deltaFeed.addWatcher(trailFeed)


        function app() {
          if (videoFeeding) {
            videoFeed.drawVideo(video)
          }
        }

        setInterval(app, 1000 / 30);
      })

      const shotDeBounce = 2000
      var isShotModel

      tf.loadModel('js_160/model.json').then((m) => {
        isShotModel = m;
        console.log('loaded model');
      });

      function predictIsShot() {
        var pixels = tf.fromPixels(trailFeed.element, 1).toFloat().div(255)
        var pred = isShotModel.predict(pixels.expandDims()).dataSync()[0]
        if (pred > 0.8) {
          shotMade(pixels)
        } else {
          document.getElementById("makingShot").style.display = "none"
        }
      }

      var timeMadeShot = 0;

      function shotMade(pixels) {
        if ((Date.now() - timeMadeShot) > shotDeBounce) {
          timeMadeShot = Date.now();
          console.log("shot made")
          document.getElementById("makingShot").style.display = "block"

          predictWhere(pixels)
        }

      }

      var whereModel
      tf.loadModel('js_160_where/model.json').then((m) => {
        whereModel = m;
        console.log('loaded model where');
      });

      function predictWhere(pixels){

            var pred = whereModel.predict(pixels.expandDims()).dataSync()
            // console.log(pred);
            // draw_where(pred[0], pred[1]);
            // x_crop = pred[0] * frame_width
            // y_crop = pred[1] * frame_height
            trailFeed.drawCross(pred[0], pred[1])
      }


    </script>
</body>

</html>